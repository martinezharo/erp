<dialog
    id="modal-historial-stock"
    class="bg-transparent m-auto backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-4xl p-0 open:animate-fade-in relative z-50"
>
    <!-- Wrapper to center/style -->
    <div
        class="bg-[#14151a] border border-white/10 rounded-3xl overflow-hidden shadow-2xl m-4 flex flex-col max-h-[90vh]"
    >
        <div
            class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5 shrink-0"
        >
            <div>
                <h3 class="text-xl font-bold text-white flex items-center gap-2" id="stock-modal-title">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-6 h-6 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Historial de Movimientos
                </h3>
                <p class="text-sm text-slate-400 mt-1" id="stock-modal-subtitle">Cargando...</p>
            </div>
            <button
                onclick="document.getElementById('modal-historial-stock').close()"
                class="text-slate-400 hover:text-white transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="flex flex-col md:flex-row h-full overflow-hidden">
            <!-- Left: History List -->
            <div class="flex-1 overflow-y-auto p-6 border-r border-white/5 custom-scrollbar">
                <div id="stock-movements-list" class="space-y-3">
                    <!-- Loaded dynamically -->
                    <div class="animate-pulse space-y-3">
                        <div class="h-16 bg-white/5 rounded-lg"></div>
                        <div class="h-16 bg-white/5 rounded-lg"></div>
                        <div class="h-16 bg-white/5 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- Right: Add Adjustment Form -->
            <div class="w-full md:w-80 bg-white/5 p-6 shrink-0 overflow-y-auto">
                <h4 class="text-sm font-bold text-white uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12h10"/><path d="M11 5h6"/><path d="M11 19h6"/><path d="M5 19V5"/></svg>
                    Ajuste Manual
                </h4>
                
                <form id="form-ajuste-stock" class="space-y-4">
                    <input type="hidden" name="productId" id="adjust-product-id" />
                    
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">
                            Fecha
                        </label>
                        <input
                            type="date"
                            name="date"
                            required
                            class="w-full bg-[#14151a] border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-orange-500 transition-all text-sm"
                        />
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">
                            Unidades (+/-)
                        </label>
                        <input
                            type="number"
                            name="units"
                            required
                            placeholder="Ej: -5 o 10"
                            class="w-full bg-[#14151a] border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-orange-500 transition-all text-sm font-mono"
                        />
                        <p class="text-xs text-slate-500 mt-1">Usa negativo para restar, positivo para sumar.</p>
                    </div>

                    <button
                        type="submit"
                        class="w-full py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium text-sm transition-all shadow-lg shadow-orange-500/20 flex items-center justify-center gap-2 mt-2"
                    >
                        Guardar Ajuste
                    </button>
                </form>
            </div>
        </div>
    </div>
</dialog>

<script>
    import type { MovimientoStock } from '../types/database';

    document.addEventListener('astro:page-load', () => {
        // Expose open function globally
        (window as any).openStockHistory = async (productId: number, productName: string) => {
            const modal = document.getElementById('modal-historial-stock') as HTMLDialogElement;
            const titleEl = document.getElementById('stock-modal-subtitle');
            const listEl = document.getElementById('stock-movements-list');
            const inputId = document.getElementById('adjust-product-id') as HTMLInputElement;
            const form = document.getElementById('form-ajuste-stock') as HTMLFormElement;

            if (!modal || !titleEl || !listEl || !inputId) return;

            // Reset state
            titleEl.textContent = `Producto: ${productName}`;
            inputId.value = productId.toString();
            listEl.innerHTML = '<div class="text-center py-8 text-slate-500"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-2"></div><p>Cargando movimientos...</p></div>';
            form.reset();
            
            // Set default date to today
            const dateInput = form.querySelector('input[name="date"]') as HTMLInputElement;
            if (dateInput) dateInput.valueAsDate = new Date();

            modal.showModal();

            try {
                const response = await fetch(`/api/stock/movements?productId=${productId}`);
                const result = await response.json();

                if (response.ok) {
                    renderMovements(result.data, listEl);
                } else {
                    listEl.innerHTML = `<div class="p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-center">Error: ${result.error}</div>`;
                }
            } catch (error) {
                listEl.innerHTML = `<div class="p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-center">Error de conexión</div>`;
            }
        };

        // Handle Form Submit
        const form = document.getElementById('form-ajuste-stock') as HTMLFormElement;
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const productId = formData.get('productId');
                const units = formData.get('units');
                const date = formData.get('date');

                try {
                    const response = await fetch('/api/stock/adjust', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId,
                            units: Number(units),
                            date
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        form.reset();
                        // Refresh list
                        const listEl = document.getElementById('stock-movements-list');
                        if (listEl) {
                             // Re-fetch movements to show new one
                            const modalSubtitle = document.getElementById('stock-modal-subtitle');
                            if (modalSubtitle) {
                                // Extract name from subtitle if needed, or just pass empty string as we don't need to update title
                                (window as any).openStockHistory(Number(productId), modalSubtitle.textContent?.replace('Producto: ', '') || '');
                            }
                        }
                        // Refresh main table
                        // Ideally we should dispatch an event or reload, but for now reload is safest
                         window.location.reload(); 
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error saving adjustment:', error);
                    alert('Error al guardar el ajuste');
                }
            });
        }
    });

    function renderMovements(movements: MovimientoStock[], container: HTMLElement) {
        if (movements.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-slate-500 border border-dashed border-white/10 rounded-xl">
                    <p>No hay movimientos registrados</p>
                </div>
            `;
            return;
        }

        container.innerHTML = movements.map(mov => {
            let icon = '';
            let colorClass = '';
            let typeLabel = '';

            switch(mov.tipo_movimiento) {
                case 'compra':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>`;
                    colorClass = 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20';
                    typeLabel = 'Compra';
                    break;
                case 'venta':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>`;
                    colorClass = 'text-blue-400 bg-blue-500/10 border-blue-500/20';
                    typeLabel = 'Venta';
                    break;
                case 'ajuste manual':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12h10"/><path d="M11 5h6"/><path d="M11 19h6"/><path d="M5 19V5"/></svg>`;
                    colorClass = 'text-orange-400 bg-orange-500/10 border-orange-500/20';
                    typeLabel = 'Ajuste Manual';
                    break;
                case 'devolucion_vta':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14L4 9l5-5"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg>`;
                    colorClass = 'text-purple-400 bg-purple-500/10 border-purple-500/20';
                    typeLabel = 'Devolución Venta';
                    break;
                case 'devolucion_com':
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14l5-5-5-5"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg>`;
                    colorClass = 'text-red-400 bg-red-500/10 border-red-500/20';
                    typeLabel = 'Devolución Compra';
                    break;
                default:
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>`;
                    colorClass = 'text-slate-400 bg-slate-500/10 border-slate-500/20';
                    typeLabel = mov.tipo_movimiento;
            }

            const isPositive = mov.unidades > 0;
            const sign = isPositive ? '+' : '';
            const amountColor = isPositive ? 'text-emerald-400' : 'text-red-400';

            return `
                <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-lg border ${colorClass}">
                            ${icon}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">${typeLabel}</p>
                            <p class="text-xs text-slate-500 font-mono">${new Date(mov.fecha).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold font-mono ${amountColor}">${sign}${mov.unidades}</span>
                        <p class="text-[10px] text-slate-600 uppercase tracking-wider">Unidades</p>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }
</style>
