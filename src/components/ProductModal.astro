<dialog
    id="modal-producto"
    class="bg-transparent m-auto backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-md p-0 open:animate-fade-in relative z-50"
>
    <!-- Wrapper to center/style -->
    <div
        class="bg-[#14151a] border border-white/10 rounded-3xl overflow-hidden shadow-2xl m-4"
    >
        <div
            class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5"
        >
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-primary-500"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="m7.5 4.27 9 5.15" />
                    <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                    <path d="m3.3 7 8.7 5 8.7-5" />
                    <path d="M12 22v-10" />
                </svg>
                Nuevo Producto
            </h3>
            <button
                onclick="document.getElementById('modal-producto').close()"
                class="text-slate-400 hover:text-white transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            </button>
        </div>

        <form id="form-producto" class="p-6 space-y-6">
            <div>
                <label
                    class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                    >Nombre del Producto</label
                >
                <input
                    type="text"
                    name="nombre"
                    required
                    placeholder="Mando LG"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary-500 transition-all placeholder-slate-600"
                />
            </div>

            <div class="flex justify-end pt-4 border-t border-white/5">
                <button
                    type="submit"
                    class="px-6 py-2.5 rounded-lg bg-primary-500 hover:bg-primary-600 text-white font-medium text-sm transition-all shadow-lg shadow-primary-500/20 flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"></path>
                    </svg>
                    Guardar Producto
                </button>
            </div>
        </form>
    </div>
</dialog>

<script>
    import { currentProject } from '../stores/projectStore';

    document.addEventListener('astro:page-load', () => {
        const form = document.getElementById('form-producto') as HTMLFormElement;
        const modal = document.getElementById('modal-producto') as HTMLDialogElement;

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const nombre = formData.get('nombre');
                
                // Get current project ID from store or URL
                let projectId: number | null = null;
                const project = currentProject.get();
                
                if (project) {
                    projectId = project.id;
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    const pid = urlParams.get('projectId');
                    if (pid) projectId = parseInt(pid);
                }

                if (!projectId) {
                    alert('Error: No se ha seleccionado ning√∫n proyecto.');
                    return;
                }

                try {
                    const response = await fetch('/api/products/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            projectId,
                            name: nombre
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        form.reset();
                        modal.close();
                        // Reload to show new product
                        window.location.reload();
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error creating product:', error);
                    alert('Error al crear el producto');
                }
            });
        }
    });
</script>
