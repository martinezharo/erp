---
import { getAuthenticatedSupabase, isDemoMode } from "../lib/supabase";

let concepts: string[] = [];

if (!isDemoMode) {
    const supabase = getAuthenticatedSupabase(Astro.cookies);

    // Fetch distinct concepts for autocomplete
    const { data: rawConcepts } = await supabase
        .from("otros_ingresos_gastos")
        .select("concepto")
        .order("concepto");

    // deduplicate
    concepts = [
        ...new Set(
            rawConcepts?.map((c: { concepto: string }) => c.concepto) || []
        ),
    ] as string[];
}
---

<dialog
    id="modal-otro"
    class="bg-transparent m-auto backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-2xl p-0 open:animate-fade-in relative z-50"
>
    <!-- Wrapper to center/style -->
    <div
        class="bg-[#14151a] border border-white/10 rounded-3xl overflow-hidden shadow-2xl m-4"
    >
        <!-- Header -->
        <div
            class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5"
        >
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-pink-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M12 2v20"></path>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                    ></path>
                </svg>
                Otros Ingresos / Gastos
            </h3>
            <button
                onclick="document.getElementById('modal-otro').close()"
                class="text-slate-400 hover:text-white transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        </div>

        <form id="form-otro" class="p-6 space-y-6">
            <!-- Tipo -->
            <div>
                <label
                    class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                    >Tipo de Transacción</label
                >
                <div class="grid grid-cols-2 gap-4">
                    <label
                        class="cursor-pointer relative border border-white/10 rounded-xl p-3 flex items-center justify-center gap-2 hover:bg-white/5 transition-all has-checked:bg-emerald-500/10 has-checked:border-emerald-500/50 has-checked:text-emerald-400"
                    >
                        <input
                            type="radio"
                            name="tipo"
                            value="ingreso"
                            class="peer hidden"
                            required
                        />
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"
                            ></polyline>
                            <polyline points="16 7 22 7 22 13"></polyline>
                        </svg>
                        <span class="font-medium">Ingreso</span>
                    </label>

                    <label
                        class="cursor-pointer relative border border-white/10 rounded-xl p-3 flex items-center justify-center gap-2 hover:bg-white/5 transition-all has-checked:bg-red-500/10 has-checked:border-red-500/50 has-checked:text-red-400"
                    >
                        <input
                            type="radio"
                            name="tipo"
                            value="gasto"
                            class="peer hidden"
                            required
                        />
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"
                            ></polyline>
                            <polyline points="16 17 22 17 22 11"></polyline>
                        </svg>
                        <span class="font-medium">Gasto</span>
                    </label>
                </div>
            </div>

            <!-- Datos Básicos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label
                        class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                        >Fecha</label
                    >
                    <input
                        type="date"
                        name="fecha"
                        required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-all"
                    />
                </div>
                <div>
                    <label
                        class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                        >Concepto</label
                    >
                    <input
                        list="conceptos-list"
                        type="text"
                        name="concepto"
                        placeholder="Selecciona o escribe..."
                        required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-all placeholder:text-slate-600"
                    />
                    <datalist id="conceptos-list">
                        {concepts.map((c) => <option value={c} />)}
                    </datalist>
                </div>
            </div>

            <!-- Importes -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label
                        class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                        >Importe (€)</label
                    >
                    <input
                        type="number"
                        name="importe"
                        step="0.01"
                        placeholder="0.00"
                        required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-all font-mono font-bold"
                    />
                </div>
                <div>
                    <label
                        class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                        >Porcentaje IVA (%) <span
                            class="text-slate-600 text-[10px] lowercase"
                            >(opcional)</span
                        >
                    </label>
                    <input
                        type="number"
                        name="porcentaje_iva"
                        step="0.1"
                        placeholder="0"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-all"
                    />
                </div>
            </div>

            <div>
                <label
                    class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2"
                    >Descripción</label
                >
                <textarea
                    name="descripcion"
                    rows="3"
                    placeholder="Detalles adicionales..."
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-all resize-none"
                ></textarea>
            </div>

            <div class="flex justify-end gap-3 pt-6 border-t border-white/5">
                <button
                    type="button"
                    onclick="document.getElementById('modal-otro').close()"
                    class="px-6 py-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all"
                >
                    Cancelar
                </button>
                <button
                    type="submit"
                    class="px-6 py-2 rounded-xl bg-purple-500 hover:bg-purple-600 text-white font-bold shadow-lg shadow-purple-500/20 transition-all"
                >
                    Guardar
                </button>
            </div>
        </form>
    </div>
</dialog>

<style>
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        animation: fade-in 0.2s ease-out;
    }
    dialog {
        margin: auto;
    }
    dialog[open] {
        animation: zoom-in 0.3s ease-out;
    }
    @keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    @keyframes zoom-in {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>

<script>
    import { currentProject } from "../stores/projectStore";

    let activeProjectId: number | null = null;

    // Subscribe to Store
    currentProject.subscribe((project) => {
        if (project) {
            activeProjectId = project.id;
        }
    });

    document.addEventListener("astro:page-load", () => {
        const modal = document.getElementById(
            "modal-otro"
        ) as HTMLDialogElement;
        const form = document.getElementById("form-otro") as HTMLFormElement;

        if (!modal || !form) return;

        // Helper to set date to today (local)
        function setDateToToday() {
            const dateInput = form?.querySelector(
                'input[name="fecha"]'
            ) as HTMLInputElement;
            if (dateInput) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, "0");
                const day = String(now.getDate()).padStart(2, "0");
                dateInput.value = `${year}-${month}-${day}`;
            }
        }

        // Observer to set date when modal opens
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (
                    mutation.type === "attributes" &&
                    mutation.attributeName === "open"
                ) {
                    if (modal.hasAttribute("open") && !form.dataset.editingId) {
                        // Reset first, then set date
                        form.reset();
                        setDateToToday();
                        // Reset editing ID
                        delete form.dataset.editingId;
                        modal.querySelector("h3")!.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            Otros Ingresos / Gastos`;
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!activeProjectId) return alert("Selecciona un proyecto");

            const formData = new FormData(form);
            const isEdit = !!form.dataset.editingId;

            const payload = {
                id: isEdit ? form.dataset.editingId : undefined,
                projectId: activeProjectId,
                tipo: formData.get("tipo"),
                fecha: formData.get("fecha"),
                concepto: formData.get("concepto"),
                descripcion: formData.get("descripcion"),
                importe: formData.get("importe"),
                porcentaje_iva: formData.get("porcentaje_iva") || 0,
            };

            const endpoint = "/api/transactions/save";

            try {
                const res = await fetch(endpoint, {
                    method: isEdit ? "PUT" : "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (res.ok) {
                    alert("Guardado correctamente");
                    window.location.reload();
                } else {
                    const err = await res.json();
                    alert("Error: " + err.error);
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexión");
            }
        });

        // Expose Edit Function
        (window as any).loadOtherTransactionForEdit = async (id: number) => {
            try {
                const res = await fetch(`/api/transactions/get-other?id=${id}`);
                if (!res.ok) throw new Error("Error loading data");
                const data = await res.json();

                if (modal && form) {
                    form.dataset.editingId = data.id.toString();

                    // Fill fields
                    const tipoInputs =
                        form.querySelectorAll('input[name="tipo"]');
                    tipoInputs.forEach((input: any) => {
                        if (input.value === data.tipo) input.checked = true;
                    });

                    const dateInput = form.querySelector(
                        'input[name="fecha"]'
                    ) as HTMLInputElement;
                    if (dateInput) dateInput.value = data.fecha.split("T")[0];

                    (
                        form.querySelector(
                            'input[name="concepto"]'
                        ) as HTMLInputElement
                    ).value = data.concepto;
                    (
                        form.querySelector(
                            'textarea[name="descripcion"]'
                        ) as HTMLInputElement
                    ).value = data.descripcion || "";
                    (
                        form.querySelector(
                            'input[name="importe"]'
                        ) as HTMLInputElement
                    ).value = data.importe;
                    (
                        form.querySelector(
                            'input[name="porcentaje_iva"]'
                        ) as HTMLInputElement
                    ).value = data.porcentaje_iva || "";

                    modal.querySelector("h3")!.textContent =
                        "Editar Transacción";
                    modal.showModal();
                }
            } catch (e) {
                console.error(e);
                alert("Error al cargar transacción");
            }
        };
    });
</script>
