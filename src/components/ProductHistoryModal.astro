<dialog
    id="modal-historial"
    class="bg-transparent m-auto backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-5xl p-0 open:animate-fade-in relative z-50"
>
    <!-- Wrapper to center/style -->
    <div
        class="bg-[#14151a] border border-white/10 rounded-3xl overflow-hidden shadow-2xl m-4 flex flex-col max-h-[90vh]"
    >
        <div
            class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5 shrink-0"
        >
            <div>
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-6 h-6 text-blue-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M3 3v18h18" />
                        <path d="m19 9-5 5-4-4-3 3" />
                    </svg>
                    Historial de Movimientos
                </h3>
                <p id="modal-product-name" class="text-slate-400 text-sm mt-1"></p>
            </div>
            <button
                onclick="document.getElementById('modal-historial').close()"
                class="text-slate-400 hover:text-white transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <!-- Add Manual Adjustment Section -->
            <div class="mb-8 p-4 rounded-xl bg-white/5 border border-white/5">
                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                    AÃ±adir Ajuste Manual
                </h4>
                <form id="form-ajuste" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="hidden" name="productId" id="ajuste-product-id" />
                    
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Fecha</label>
                        <input
                            type="date"
                            name="date"
                            required
                            class="w-full bg-[#14151a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500 transition-all"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Unidades (+/-)</label>
                        <input
                            type="number"
                            name="units"
                            required
                            placeholder="Ej: 5 o -2"
                            step="1"
                            class="w-full bg-[#14151a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500 transition-all"
                        />
                    </div>

                    <div class="md:col-span-2">
                        <button
                            type="submit"
                            class="w-full px-4 py-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 font-medium text-sm transition-all flex items-center justify-center gap-2"
                        >
                            Registrar Ajuste
                        </button>
                    </div>
                </form>
            </div>

            <!-- Movements Table -->
            <div class="overflow-x-auto rounded-xl border border-white/5">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-white/5 text-xs uppercase font-semibold text-slate-200">
                        <tr>
                            <th class="px-4 py-3">Fecha</th>
                            <th class="px-4 py-3">Tipo</th>
                            <th class="px-4 py-3 text-right">Unidades</th>
                            <th class="px-4 py-3 text-right">Precio Unit.</th>
                            <th class="px-4 py-3">Canal / Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="movements-table-body" class="divide-y divide-white/5">
                        <!-- Content populated by JS -->
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center italic">Cargando historial...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</dialog>

<script>
    document.addEventListener('astro:page-load', () => {
        const modal = document.getElementById('modal-historial') as HTMLDialogElement;
        const productNameEl = document.getElementById('modal-product-name');
        const tableBody = document.getElementById('movements-table-body');
        const adjustForm = document.getElementById('form-ajuste') as HTMLFormElement;
        const productIdInput = document.getElementById('ajuste-product-id') as HTMLInputElement;

        // Expose function globally to open modal
        (window as any).openProductHistory = async (productId: number, productName: string) => {
            if (!modal || !productNameEl || !tableBody || !productIdInput) return;
            
            productNameEl.textContent = productName;
            productIdInput.value = productId.toString();
            tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center italic">Cargando historial...</td></tr>';
            
            // Reset form date to today
            const dateInput = adjustForm.querySelector('input[type="date"]') as HTMLInputElement;
            if (dateInput) dateInput.valueAsDate = new Date();

            modal.showModal();

            try {
                const response = await fetch(`/api/stock/movements?productId=${productId}`);
                const result = await response.json();

                if (response.ok) {
                    renderTable(result.data);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-400">Error: ${result.error}</td></tr>`;
                }
            } catch (error) {
                console.error("Error fetching history:", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-400">Error al cargar historial</td></tr>';
            }
        };

        // Handle Adjustment Form Submit
        if (adjustForm) {
            adjustForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(adjustForm);
                const productId = formData.get('productId');
                const units = formData.get('units');
                const date = formData.get('date');

                try {
                    const response = await fetch('/api/stock/adjust', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId: parseInt(productId as string),
                            units: parseInt(units as string),
                            date
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Refresh table
                        adjustForm.reset();
                        // Restore ID and Date
                        productIdInput.value = productId as string;
                        const dateInput = adjustForm.querySelector('input[type="date"]') as HTMLInputElement;
                        if (dateInput) dateInput.valueAsDate = new Date();

                        // Reload movements
                        const histResponse = await fetch(`/api/stock/movements?productId=${productId}`);
                        const histResult = await histResponse.json();
                        if (histResponse.ok) renderTable(histResult.data);
                        
                        // Optionally reload main page data in background or notify user
                        // For now we just update the modal view
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error("Error saving adjustment:", error);
                    alert("Error al guardar el ajuste");
                }
            });
        }

        function renderTable(movements: any[]) {
            if (!tableBody) return;
            
            if (movements.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">No hay movimientos registrados.</td></tr>';
                return;
            }

            tableBody.innerHTML = movements.map(m => {
                const isPositive = m.unidades > 0;
                const typeClass = m.tipo === 'venta' ? 'text-blue-400' : 
                                 m.tipo === 'compra' ? 'text-emerald-400' : 'text-slate-200';
                
                const formattedDate = new Date(m.fecha).toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });

                const formattedPrice = m.precio !== null 
                    ? new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(m.precio)
                    : '-';

                return `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-4 py-3 text-slate-300">${formattedDate}</td>
                        <td class="px-4 py-3 font-medium ${typeClass} capitalize">${m.tipo.replace('_', ' ')}</td>
                        <td class="px-4 py-3 text-right font-mono ${isPositive ? 'text-emerald-400' : 'text-red-400'}">
                            ${isPositive ? '+' : ''}${m.unidades}
                        </td>
                        <td class="px-4 py-3 text-right font-mono text-slate-300">${formattedPrice}</td>
                        <td class="px-4 py-3 text-slate-400">${m.canal || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
    });
</script>
