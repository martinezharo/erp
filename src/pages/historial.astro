---
import Layout from "../layouts/Layout.astro";
import { getAuthenticatedSupabase } from "../lib/supabase";

const { cookies } = Astro;
const supabase = getAuthenticatedSupabase(cookies);

const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect("/login");
}

// Get Project
const { data: projects } = await supabase
  .from("proyectos")
  .select("id, nombre")
  .limit(5);

const projectIdParam = Astro.url.searchParams.get("projectId");
let projectId = projectIdParam
  ? parseInt(projectIdParam)
  : projects?.[0]?.id || null;

const viewParam = Astro.url.searchParams.get("view") || "month";
// Valid views: 'month', 'quarter', 'year', 'total'

let historyData = [];

if (projectId) {
  const { data } = await supabase
    .from("vista_finanzas_diarias")
    .select("*")
    .eq("proyecto_id", projectId)
    .order("dia", { ascending: false });

  if (data) {
    historyData = data;
  }
}

// Helper to group data
const groupedData = new Map();

historyData.forEach((item) => {
  const date = new Date(item.dia);
  const year = date.getFullYear();
  let key = "";
  let label = "";
  let sortKey = "";

  if (viewParam === "month") {
    const month = date.getMonth();
    key = `${year}-${month}`;
    const dateStr = new Intl.DateTimeFormat("es-ES", {
      month: "short",
      year: "numeric",
    }).format(date);
    // Capitalize first letter and ensure dot if missing (though "short" usually has it or not depending on locale impl, we want "Feb. 2024")
    label = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    // Sort by date descending
    sortKey = `${year}-${String(month).padStart(2, "0")}`;
  } else if (viewParam === "quarter") {
    const quarter = Math.floor(date.getMonth() / 3) + 1;
    key = `${year}-Q${quarter}`;
    label = `T${quarter} ${year}`;
    sortKey = key;
  } else if (viewParam === "year") {
    key = `${year}`;
    label = `${year}`;
    sortKey = key;
  } else {
    key = "total";
    label = "Total Histórico";
    sortKey = "0";
  }

  // Init group if not exists
  if (!groupedData.has(key)) {
    groupedData.set(key, {
      key,
      label,
      sortKey,
      ingresos: 0,
      gastos: 0,
      balance: 0,
      urp: 0,
    });
  }

  // Accumulate
  const group = groupedData.get(key);
  group.ingresos += item.ingresos || 0;
  group.gastos += item.gastos || 0;
  group.balance += item.balance || 0;
  group.urp += item.urp || 0;
});

// Convert map to array and sort
const sortedGroups = Array.from(groupedData.values()).sort((a, b) => {
  if (viewParam === "total") return 0;
  return b.sortKey.localeCompare(a.sortKey);
});

// Formatter
const formatCurrency = (value: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 2,
  }).format(value);
};

const viewOptions = [
  { value: "month", label: "Meses" },
  { value: "quarter", label: "Trimestres" },
  { value: "year", label: "Años" },
  { value: "total", label: "Total" },
];
---

<Layout title="OlivERP | Historial">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
    <div>
      <h1 class="text-2xl font-bold text-white mb-2">Historial Financiero</h1>
      <p class="text-slate-400 text-sm">
        Visualiza el rendimiento financiero agrupado por periodos.
      </p>
    </div>

    <div class="flex bg-[#14151a] p-1 rounded-xl border border-white/5">
      {
        viewOptions.map((option) => (
          <a
            href={`?projectId=${projectId}&view=${option.value}`}
            class:list={[
              "px-4 py-2 text-sm font-medium rounded-lg transition-all",
              viewParam === option.value
                ? "bg-blue-500/10 text-blue-400 shadow-sm"
                : "text-slate-400 hover:text-white hover:bg-white/5",
            ]}
          >
            {option.label}
          </a>
        ))
      }
    </div>
  </div>

  {!projectId ? (
    <div class="text-center py-20">
      <p class="text-slate-500">Selecciona un proyecto para ver su historial.</p>
    </div>
  ) : (
    <div class="flex flex-col gap-4">
        {/* Table Header */}
        <div class="hidden md:grid md:grid-cols-5 gap-4 px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider bg-[#14151a]/50 rounded-xl border border-white/5">
            <div>Periodo</div>
            <div class="text-right">Ingresos</div>
            <div class="text-right">Gastos</div>
            <div class="text-right">Balance</div>
            <div class="text-right">URP</div>
        </div>

      {sortedGroups.map((group) => (
        <div class="rounded-2xl bg-[#14151a] border border-white/5 p-4 md:px-6 md:py-4 relative group hover:border-white/10 transition-colors">
            <div class="flex flex-col md:grid md:grid-cols-5 md:items-center gap-4">
                {/* Periodo y Status Icon */}
                <div class="flex items-center justify-between md:justify-start gap-3">
                    <div class={`p-1.5 rounded-lg ${group.balance >= 0 ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}`}>
                        {group.balance >= 0 ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                        ) : (
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>
                        )}
                    </div>
                    <span class="text-white font-medium capitalize md:truncate">{group.label}</span>
                </div>

                {/* Métricas - Mobile: Grid 2 col, Desktop: Aligned columns */}
                <div class="grid grid-cols-2 gap-4 md:contents">
                    <div class="flex flex-col md:block md:text-right">
                        <span class="md:hidden text-xs text-slate-500 mb-1">Ingresos</span>
                        <span class="text-emerald-400 font-bold">{formatCurrency(group.ingresos)}</span>
                    </div>
                    
                    <div class="flex flex-col md:block md:text-right">
                        <span class="md:hidden text-xs text-slate-500 mb-1">Gastos</span>
                        <span class="text-red-400 font-bold">{formatCurrency(group.gastos)}</span>
                    </div>

                    <div class="flex flex-col md:block md:text-right">
                        <span class="md:hidden text-xs text-slate-500 mb-1">Balance</span>
                        <span class={`font-bold ${group.balance >= 0 ? 'text-white' : 'text-red-400'}`}>
                            {formatCurrency(group.balance)}
                        </span>
                    </div>

                    <div class="flex flex-col md:block md:text-right">
                        <span class="md:hidden text-xs text-slate-500 mb-1">URP</span>
                        <span class={`font-bold ${group.urp >= 0 ? 'text-blue-400' : 'text-red-400'}`}>
                            {formatCurrency(group.urp)}
                        </span>
                    </div>
                </div>
            </div>
        </div>
      ))}
    </div>
  )}
</Layout>
