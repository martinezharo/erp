---
import Layout from "../layouts/Layout.astro";
import TransactionsList from "../components/TransactionsList.astro";
import SalesModal from "../components/SalesModal.astro";
import PurchaseModal from "../components/PurchaseModal.astro";
import OtherTransactionModal from "../components/OtherTransactionModal.astro";
import Pagination from "../components/Pagination.astro";
import { getAuthenticatedSupabase, isDemoMode } from "../lib/supabase";
import { mockFinanzas, mockProjects } from "../lib/mock-data";
import type { VistaFinanzasDiarias } from "../types/database";

let data: VistaFinanzasDiarias[] = [];
let errorMsg = "";

// Get Project ID
const projectIdParam = Astro.url.searchParams.get("projectId");
let projectId = projectIdParam ? parseInt(projectIdParam) : null;

// Pagination
const pageParam = Astro.url.searchParams.get("page");
const page = pageParam ? parseInt(pageParam) : 1;
const pageSize = 15;
const from = (page - 1) * pageSize;
const to = from + pageSize - 1;

let totalCount = 0;
let totalPages = 0;

if (isDemoMode) {
    if (!projectId) {
        projectId = mockProjects[0]?.id || null;
    }

    if (projectId) {
        const filtered = mockFinanzas
            .filter((f) => f.proyecto_id === projectId)
            .sort((a, b) => b.dia.localeCompare(a.dia));

        totalCount = filtered.length;
        totalPages = Math.ceil(totalCount / pageSize);
        data = filtered.slice(from, to + 1);
    }
} else {
    const supabase = getAuthenticatedSupabase(Astro.cookies);

    if (!projectId) {
        const { data: projects } = await supabase
            .from("proyectos")
            .select("id")
            .order("id", { ascending: true })
            .limit(1);

        if (projects && projects.length > 0) {
            projectId = projects[0].id;
        }
    }

    if (projectId) {
        const {
            data: transactionsData,
            error,
            count,
        } = await supabase
            .from("vista_finanzas_diarias")
            .select("*", { count: "exact" })
            .eq("proyecto_id", projectId)
            .order("dia", { ascending: false })
            .range(from, to);

        if (error) {
            errorMsg = error.message;
        } else {
            data = transactionsData || [];
            totalCount = count || 0;
            totalPages = Math.ceil(totalCount / pageSize);
        }
    }
}
---

<Layout title="OlivERP | Transacciones">
    {
        isDemoMode && (
            <div class="mb-6 px-4 py-3 rounded-xl bg-amber-500/10 border border-amber-500/20 text-amber-400 text-sm flex items-center gap-3">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5 shrink-0"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span>
                    <strong>Modo Demo</strong> â€” Datos de ejemplo.
                </span>
            </div>
        )
    }

    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1
                class="text-3xl font-bold bg-clip-text text-transparent bg-linear-to-r from-white to-slate-400"
            >
                Transacciones
            </h1>
            <p class="text-slate-400 mt-2">
                Finanzas diarias, ingresos y gastos
            </p>
        </div>
    </div>

    {
        errorMsg && (
            <div class="p-4 mb-6 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400">
                Error cargando datos: {errorMsg}
            </div>
        )
    }

    <TransactionsList transactions={data} />

    <div class="mt-8">
        <Pagination
            currentPage={page}
            totalPages={totalPages}
            baseUrl={`/transacciones?projectId=${projectId || ""}`}
        />
    </div>

    <SalesModal />
    <PurchaseModal />
    <OtherTransactionModal />
</Layout>
